{% extends "base.html" %}

{% block title %}Carga de Datos{% endblock %}

{% block content %}
<!-- Page Header -->
<h1 class="text-3xl font-semibold text-slate-900 mb-6">Cargar Datos</h1>

<!-- ***** NEW: ERROR DISPLAY ***** -->
{% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
        <strong class="font-bold">Error al Generar:</strong>
        <span class="block sm:inline">{{ error }}</span>
    </div>
{% endif %}
<!-- **************************** -->

<!-- Progress Bar (now using Tailwind) -->
<div class="w-full bg-slate-200 rounded-full h-2.5 mb-6 hidden progress-bar">
    <div class="bg-green-500 h-2.5 rounded-full progress-fill" style="width: 0%"></div>
</div>

<!-- Grid for Form Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-8">

    <!-- Card 1: Manual Entry (MODIFIED) -->
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold text-slate-800 mb-5 border-b border-slate-200 pb-3">Ingreso Manual</h2>
        <form id="manualForm" action="/generar" method="POST" class="space-y-4">
            
            <!-- Cédula (Moved to top) -->
            <div>
                <label for="cedula" class="block text-sm font-medium text-slate-700">Cédula</label>
                <input type="text" id="cedula" name="cedula" placeholder="Ej: 1234567" required
                       class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <!-- Status/Error message area -->
                <div class="text-sm mt-2" id="api-status"></div>
            </div>

            <!-- Manual Toggle Checkbox -->
            <div class="flex items-center">
                <input type="checkbox" id="manual-toggle" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                <label for="manual-toggle" class="ml-2 block text-sm text-slate-700">Cargar manualmente</label>
            </div>
            
            <!-- Other fields (now auto-filled or manual) -->
            <div>
                <label for="nombres" class="block text-sm font-medium text-slate-700">Nombres</label>
                <input type="text" id="nombres" name="nombres" placeholder="Se llenará automáticamente..." required
                       class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
                <label for="grupo" class="block text-sm font-medium text-slate-700">Grupo</label>
                <input type="text" id="grupo" name="grupo" placeholder="Se llenará automáticamente..." required
                       class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
                <label for="distrito" class="block text-sm font-medium text-slate-700">Distrito</label>
                <input type="text" id="distrito" name="distrito" placeholder="Se llenará automáticamente..." required
                       class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
                <label for="region" class="block text-sm font-medium text-slate-700">Región</label>
                <input type="text" id="region" name="region" placeholder="Se llenará automáticamente..." required
                       class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-700 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                Generar Reconocimiento
            </button>
        </form>
    </div>

    <!-- Card 2: CSV Upload (Unchanged) -->
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold text-slate-800 mb-5 border-b border-slate-200 pb-3 flex items-center justify-between">
            Subir CSV
            <!-- Tailwind Tooltip -->
            <div class="relative group">
                <span class="text-blue-500 cursor-help">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </span>
                <div class="absolute bottom-full right-0 mb-2 w-72 p-3 bg-slate-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10">
                    <span class="font-bold block">Formato requerido:</span>
                    <code class="text-xs">nombres,cedula,grupo,distrito,region</code>
                    <span class="font-bold block mt-2">Ejemplo:</span>
                    <code class="text-xs">"Juan Pérez",1-2345-6789,Grupo A,Distrito Norte,Región Central</code>
                    <div class="absolute w-3 h-3 bg-slate-800 rotate-45 -bottom-1 right-4"></div> <!-- Tooltip arrow -->
                </div>
            </div>
        </h2>
        <form action="/cargar-csv" method="POST" enctype="multipart/form-data" class="space-y-4">
            <div>
                <label for="csv" class="block text-sm font-medium text-slate-700">Archivo CSV</label>
                <input type="file" id="csv" name="csv" accept=".csv" required
                       class="mt-1 block w-full text-sm text-slate-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-full file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-50 file:text-blue-700
                              hover:file:bg-blue-100">
            </div>
            
            <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                Subir y Generar
            </button>
        </form>
    </div>
</div>

<script>
    // --- NEW SCRIPT FOR AUTO-FILL ---
    document.addEventListener('DOMContentLoaded', () => {
        // Get all the form elements
        const manualToggle = document.getElementById('manual-toggle');
        const cedulaInput = document.getElementById('cedula');
        const nombresInput = document.getElementById('nombres');
        const grupoInput = document.getElementById('grupo');
        const distritoInput = document.getElementById('distrito');
        const regionInput = document.getElementById('region');
        const apiStatus = document.getElementById('api-status');
        const fields = [nombresInput, grupoInput, distritoInput, regionInput];

        // Function to toggle readonly state and styles
        function setFormReadOnly(isReadOnly) {
            fields.forEach(field => {
                field.readOnly = isReadOnly;
                if (isReadOnly) {
                    field.classList.add('bg-slate-100', 'text-slate-500');
                    field.placeholder = 'Se llenará automáticamente...';
                } else {
                    field.classList.remove('bg-slate-100', 'text-slate-500');
                    field.placeholder = '';
                }
            });
        }

        // 1. Set initial state on page load
        setFormReadOnly(true);

        // 2. Add listener to the checkbox
        manualToggle.addEventListener('change', () => {
            setFormReadOnly(!manualToggle.checked);
            // Clear fields and status if user toggles to manual
            if (manualToggle.checked) {
                apiStatus.innerHTML = '';
                fields.forEach(field => field.value = '');
            }
        });

        // 3. Add listener to the cedula input (on 'blur' - when user clicks away)
        cedulaInput.addEventListener('blur', async () => {
            // Only fetch if we are in "auto-fill" mode (checkbox is OFF)
            if (!manualToggle.checked) {
                const cedula = cedulaInput.value.trim();
                if (!cedula) return;

                // Show loading message
                apiStatus.innerHTML = '<span class="text-slate-500">Buscando...</span>';
                fields.forEach(field => field.value = '...');

                try {
                    const response = await fetch(`/api/get-scout-data/${cedula}`);
                    const data = await response.json();

                    if (!response.ok) {
                        // Handle errors from our API (e.g., 404, 500)
                        apiStatus.innerHTML = `<span class="text-red-600 font-medium">Error: ${data.error || 'Cédula no encontrada.'}</span>`;
                        fields.forEach(field => field.value = '');
                    } else if (data.status.toLowerCase() !== 'activo') {
                        // Handle non-active member
                        apiStatus.innerHTML = `<span class="text-yellow-700 font-medium">Atención: El miembro no está 'activo' (Estado: ${data.status}).</span>`;
                        fields.forEach(field => field.value = '');
                    } else {
                        // SUCCESS! Fill the fields
                        apiStatus.innerHTML = '<span class="text-green-600 font-medium">¡Miembro encontrado!</span>';
                        nombresInput.value = data.nombre;
                        grupoInput.value = data.grupo;
                        distritoInput.value = data.distrito;
                        regionInput.value = data.region;
                    }

                } catch (error) {
                    // Handle network errors
                    console.error('Fetch error:', error);
                    apiStatus.innerHTML = '<span class="text-red-600 font-medium">Error de red. No se pudo conectar.</span>';
                    fields.forEach(field => field.value = '');
                }
            }
        });
    });

    // --- Original Progress Bar Script ---
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(event) { // Added 'event'
            // Check if this is the manual form and if it's valid
            if (this.id === 'manualForm') {
                const apiStatusText = document.getElementById('api-status').textContent;
                // Don't submit if there's an error message
                if ((apiStatusText.includes('Error') || apiStatusText.includes('Atención')) && !document.getElementById('manual-toggle').checked) {
                    event.preventDefault(); // Stop form submission
                    // We can't use alert(), so let's reuse the api-status
                    const apiStatus = document.getElementById('api-status');
                    apiStatus.innerHTML = '<span class="text-red-600 font-medium">Error: Por favor, corrija los errores (o marque "Cargar manualmente")</span>';
                    return;
                }
            }

            // --- Progress bar logic ---
            const progressBar = document.querySelector('.progress-bar');
            const progressFill = document.querySelector('.progress-fill');
            
            progressBar.classList.remove('hidden');
            let width = 0;
            const interval = setInterval(() => {
                width += 10;
                progressFill.style.width = width + '%';
                if (width >= 100) {
                    clearInterval(interval);
                    setTimeout(() => { 
                        progressBar.classList.add('hidden');
                        progressFill.style.width = '0%';
                    }, 2000); // Hide after 2 seconds
                }
            }, 200); // Faster interval
        });
    });
</script>
{% endblock %}